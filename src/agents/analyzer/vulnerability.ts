/**
 * Vulnerability scanner using OWASP ZAP and TLS checks
 * Dependencies: @vibecode-audit/shared
 * Purpose: Scan for security vulnerabilities and return findings
 */
import type { Finding } from '../../types';
import type { EventBus } from '../communication';
import type { SecurityData } from '../scanner/extractor';

export async function scanVulnerabilities(
  data: SecurityData,
  eventBus: EventBus,
  jobId: string
): Promise<Finding[]> {
  await eventBus.publish(jobId, {
    type: 'agent.started',
    agent: 'analyzer.vulnerability',
    jobId,
    timestamp: Date.now(),
  });

  const findings: Finding[] = [];

  await eventBus.publish(jobId, {
    type: 'agent.progress',
    agent: 'analyzer.vulnerability',
    jobId,
    timestamp: Date.now(),
    progress: 20,
    message: 'Checking security headers',
  });

  if (!data.headers.hsts) {
    findings.push({
      type: 'missing-hsts',
      severity: 'high',
      evidence: 'Strict-Transport-Security header not found',
      cwe: 'CWE-319',
      recommendation: 'Add HSTS header to enforce HTTPS',
    });
  }

  if (!data.headers.csp) {
    findings.push({
      type: 'missing-csp',
      severity: 'medium',
      evidence: 'Content-Security-Policy header not found',
      cwe: 'CWE-79',
      recommendation: 'Add CSP header to prevent XSS attacks',
    });
  }

  if (!data.headers.xFrameOptions) {
    findings.push({
      type: 'missing-x-frame-options',
      severity: 'medium',
      evidence: 'X-Frame-Options header not found',
      cwe: 'CWE-1021',
      recommendation: 'Add X-Frame-Options to prevent clickjacking',
    });
  }

  await eventBus.publish(jobId, {
    type: 'agent.progress',
    agent: 'analyzer.vulnerability',
    jobId,
    timestamp: Date.now(),
    progress: 50,
    message: 'Analyzing cookies',
  });

  data.cookies.forEach((cookie) => {
    if (!cookie.secure) {
      findings.push({
        type: 'insecure-cookie',
        severity: 'high',
        evidence: `Cookie "${cookie.name}" missing Secure flag`,
        cwe: 'CWE-614',
        recommendation: 'Set Secure flag on all cookies',
      });
    }
    if (!cookie.httpOnly && cookie.name.toLowerCase().includes('session')) {
      findings.push({
        type: 'session-cookie-xss-risk',
        severity: 'high',
        evidence: `Session cookie "${cookie.name}" missing HttpOnly flag`,
        cwe: 'CWE-1004',
        recommendation: 'Set HttpOnly flag on session cookies',
      });
    }
  });

  await eventBus.publish(jobId, {
    type: 'agent.progress',
    agent: 'analyzer.vulnerability',
    jobId,
    timestamp: Date.now(),
    progress: 70,
    message: 'Checking forms',
  });

  data.forms.forEach((form) => {
    if (form.method === 'GET' && form.inputs.some((i) => i.toLowerCase().includes('password'))) {
      findings.push({
        type: 'password-in-get',
        severity: 'critical',
        evidence: `Form at "${form.action}" uses GET method with password field`,
        cwe: 'CWE-598',
        recommendation: 'Use POST method for forms with sensitive data',
      });
    }
  });

  await eventBus.publish(jobId, {
    type: 'agent.completed',
    agent: 'analyzer.vulnerability',
    jobId,
    timestamp: Date.now(),
    data: { findingsCount: findings.length },
  });

  return findings;
}

