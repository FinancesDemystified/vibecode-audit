/**
 * Vulnerability scanner - concrete security checks only
 * Dependencies: @vibecode-audit/shared
 * Purpose: Scan for concrete security vulnerabilities (no inference)
 */
import type { Finding } from '../../types';
import type { EventBus } from '../communication';
import type { SecurityData } from '../scanner/extractor';

export async function scanVulnerabilities(
  data: SecurityData,
  eventBus: EventBus,
  jobId: string
): Promise<Finding[]> {
  await eventBus.publish(jobId, {
    type: 'agent.started',
    agent: 'analyzer.vulnerability',
    jobId,
    timestamp: Date.now(),
  });

  const findings: Finding[] = [];

  await eventBus.publish(jobId, {
    type: 'agent.progress',
    agent: 'analyzer.vulnerability',
    jobId,
    timestamp: Date.now(),
    progress: 20,
    message: 'Checking security headers',
  });

  // OWASP recommended headers - concrete checks only
  if (!data.headers.hsts) {
    findings.push({
      type: 'missing-hsts',
      severity: 'high',
      evidence: 'Strict-Transport-Security header not found',
      cwe: 'CWE-319',
      recommendation: 'Add HSTS header: Strict-Transport-Security: max-age=31536000; includeSubDomains',
    });
  }

  if (!data.headers.csp) {
    findings.push({
      type: 'missing-csp',
      severity: 'medium',
      evidence: 'Content-Security-Policy header not found',
      cwe: 'CWE-79',
      recommendation: 'Add CSP header to prevent XSS attacks',
    });
  } else {
    // Validate CSP policy quality
    const csp = data.headers.csp.toLowerCase();
    if (csp.includes('unsafe-inline')) {
      findings.push({
        type: 'csp-unsafe-inline',
        severity: 'medium',
        evidence: `CSP contains 'unsafe-inline' directive: ${data.headers.csp}`,
        cwe: 'CWE-79',
        recommendation: 'Remove unsafe-inline from CSP, use nonces or hashes instead',
      });
    }
    if (csp.includes('unsafe-eval')) {
      findings.push({
        type: 'csp-unsafe-eval',
        severity: 'medium',
        evidence: `CSP contains 'unsafe-eval' directive: ${data.headers.csp}`,
        cwe: 'CWE-79',
        recommendation: 'Remove unsafe-eval from CSP',
      });
    }
    if (!csp.includes('frame-ancestors') && !csp.includes('default-src')) {
      findings.push({
        type: 'csp-missing-frame-ancestors',
        severity: 'low',
        evidence: 'CSP missing frame-ancestors directive',
        cwe: 'CWE-1021',
        recommendation: 'Add frame-ancestors \'none\' to CSP',
      });
    }
  }

  if (!data.headers.xFrameOptions) {
    findings.push({
      type: 'missing-x-frame-options',
      severity: 'medium',
      evidence: 'X-Frame-Options header not found',
      cwe: 'CWE-1021',
      recommendation: 'Add X-Frame-Options: deny',
    });
  }

  if (!data.headers.xContentTypeOptions) {
    findings.push({
      type: 'missing-x-content-type-options',
      severity: 'medium',
      evidence: 'X-Content-Type-Options header not found',
      cwe: 'CWE-693',
      recommendation: 'Add X-Content-Type-Options: nosniff',
    });
  }

  // Check for information disclosure headers
  const serverHeader = data.headers.server || data.headers.xPoweredBy || 
                       data.headers.xAspNetVersion || data.headers.xAspNetMvcVersion;
  if (serverHeader) {
    findings.push({
      type: 'information-disclosure-server',
      severity: 'low',
      evidence: `Server information disclosed: ${serverHeader}`,
      cwe: 'CWE-200',
      recommendation: 'Remove or obfuscate Server/X-Powered-By headers',
    });
  }

  await eventBus.publish(jobId, {
    type: 'agent.progress',
    agent: 'analyzer.vulnerability',
    jobId,
    timestamp: Date.now(),
    progress: 50,
    message: 'Analyzing cookies',
  });

  data.cookies.forEach((cookie) => {
    if (!cookie.secure) {
      findings.push({
        type: 'insecure-cookie',
        severity: 'high',
        evidence: `Cookie "${cookie.name}" missing Secure flag`,
        cwe: 'CWE-614',
        recommendation: 'Set Secure flag on all cookies',
      });
    }
    if (!cookie.httpOnly && cookie.name.toLowerCase().includes('session')) {
      findings.push({
        type: 'session-cookie-xss-risk',
        severity: 'high',
        evidence: `Session cookie "${cookie.name}" missing HttpOnly flag`,
        cwe: 'CWE-1004',
        recommendation: 'Set HttpOnly flag on session cookies',
      });
    }
    if (cookie.sameSite && cookie.sameSite.toLowerCase() === 'none' && !cookie.secure) {
      findings.push({
        type: 'cookie-samesite-insecure',
        severity: 'high',
        evidence: `Cookie "${cookie.name}" has SameSite=None without Secure flag`,
        cwe: 'CWE-614',
        recommendation: 'SameSite=None requires Secure flag',
      });
    }
    if (!cookie.sameSite) {
      findings.push({
        type: 'cookie-missing-samesite',
        severity: 'medium',
        evidence: `Cookie "${cookie.name}" missing SameSite attribute`,
        cwe: 'CWE-352',
        recommendation: 'Add SameSite=Strict or SameSite=Lax to cookies',
      });
    }
  });

  await eventBus.publish(jobId, {
    type: 'agent.progress',
    agent: 'analyzer.vulnerability',
    jobId,
    timestamp: Date.now(),
    progress: 70,
    message: 'Checking forms',
  });

  data.forms.forEach((form) => {
    if (form.method === 'GET' && form.inputs.some((i) => i.toLowerCase().includes('password'))) {
      findings.push({
        type: 'password-in-get',
        severity: 'critical',
        evidence: `Form at "${form.action}" uses GET method with password field`,
        cwe: 'CWE-598',
        recommendation: 'Use POST method for forms with sensitive data',
      });
    }
  });

  await eventBus.publish(jobId, {
    type: 'agent.completed',
    agent: 'analyzer.vulnerability',
    jobId,
    timestamp: Date.now(),
    data: { findingsCount: findings.length },
  });

  return findings;
}

